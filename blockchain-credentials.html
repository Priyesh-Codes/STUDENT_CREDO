<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Credentials - STUDENT Credo</title>
    <link rel="stylesheet" href="blockchain-credentials.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <!-- Mode Toggle -->
                <div class="mode-toggle-container">
                    <div class="mode-toggle">
                        <input type="radio" id="studentMode" name="userMode" value="student" checked>
                        <label for="studentMode" class="mode-option">Student</label>
                        <input type="radio" id="adminMode" name="userMode" value="admin">
                        <label for="adminMode" class="mode-option">Admin</label>
                        <div class="mode-slider"></div>
                    </div>
                </div>
                
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="logo-text">
                        <span class="logo-title">STUDENT Credo</span>
                        <span class="logo-subtitle">Achievement Hub</span>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <div class="nav-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="achievements.html" class="nav-item">
                    <div class="nav-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <span class="nav-text">Achievements</span>
                </a>
                <a href="upload-achievement.html" class="nav-item">
                    <div class="nav-icon">
                        <i class="fas fa-upload"></i>
                    </div>
                    <span class="nav-text">Upload Achievement</span>
                </a>
                <a href="skills-analysis.html" class="nav-item">
                    <div class="nav-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <span class="nav-text">Skills Analysis</span>
                </a>
                <a href="digital-passport.html" class="nav-item">
                    <div class="nav-icon">
                        <i class="fas fa-folder"></i>
                    </div>
                    <span class="nav-text">Digital Passport</span>
                </a>
                <a href="blockchain-credentials.html" class="nav-item active">
                    <div class="nav-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <span class="nav-text">Blockchain Credentials</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        <img src="profile-pic.jpg" alt="Profile">
                    </div>
                    <div class="user-info">
                        <h4>Priyesh Kumar Kashyap</h4>
                        <p>BT24CS063</p>
                    </div>
                    <button class="settings-btn">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="page-header">
                <div class="header-left">
                    <div class="header-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <div class="header-text">
                        <h1>Blockchain Credentials</h1>
                        <p>Immutable, verified achievement records on blockchain</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="blockchain-status">
                        <div class="status-indicator active">
                            <i class="fas fa-shield-alt"></i>
                            <span id="blockchainStatusCount">4</span>
                        </div>
                    </div>
                </div>
            </header>

          

            <!-- Blockchain Credentials List -->
            <div class="content-card credentials-card">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-cubes"></i>
                        Your Blockchain Credentials
                    </h3>
                    <div class="header-actions">
                        <button class="verify-btn" id="verifyAllBtn">
                            <i class="fas fa-check-double"></i>
                            Verify All
                        </button>
                        <button class="export-btn" id="exportBlockchainBtn">
                            <i class="fas fa-download"></i>
                            Export Blockchain Data
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <!-- Empty State -->
                    <div class="empty-state" id="emptyState">
                        <div class="empty-icon">
                            <i class="fas fa-cubes"></i>
                        </div>
                        <h3>No blockchain credentials yet</h3>
                        <p>Your verified achievements will automatically appear here once approved by admin</p>
                        <a href="upload-achievement.html" class="upload-btn">
                            <i class="fas fa-upload"></i>
                            Upload Achievement
                        </a>
                    </div>

                    <!-- Blockchain Credentials Grid -->
                    <div class="blockchain-grid" id="blockchainGrid" style="display: none;">
                        <!-- Blockchain credentials will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Verification Modal -->
            <div class="modal-overlay" id="verificationModal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>
                            <i class="fas fa-search"></i>
                            Credential Verification
                        </h3>
                        <button class="close-btn" onclick="closeVerificationModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="verification-details" id="verificationDetails">
                            <!-- Verification details will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="shared-utils.js"></script>
    <script src="blockchain-credentials.js"></script>
    <script>
        // Initialize mode toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeModeToggle();
            initializeBlockchainCredentials();
        });

        function initializeModeToggle() {
            const studentMode = document.getElementById('studentMode');
            const adminMode = document.getElementById('adminMode');
            const logoTitle = document.querySelector('.logo-title');
            
            const savedMode = localStorage.getItem('userMode') || 'student';
            
            if (savedMode === 'admin') {
                adminMode.checked = true;
                updateModeDisplay('admin');
            } else {
                studentMode.checked = true;
                updateModeDisplay('student');
            }
            
            studentMode.addEventListener('change', function() {
                if (this.checked) {
                    updateModeDisplay('student');
                    localStorage.setItem('userMode', 'student');
                }
            });
            
            adminMode.addEventListener('change', function() {
                if (this.checked) {
                    localStorage.setItem('userMode', 'admin');
                    window.location.href = 'admin-dashboard.html';
                }
            });
            
            function updateModeDisplay(mode) {
                if (mode === 'admin') {
                    logoTitle.textContent = 'ADMIN Credo';
                } else {
                    logoTitle.textContent = 'STUDENT Credo';
                }
            }
        }

        function initializeBlockchainCredentials() {
            loadBlockchainCredentials();
            updateBlockchainStats();
            setupEventListeners();
        }

        function setupEventListeners() {
            document.getElementById('verifyAllBtn').addEventListener('click', verifyAllCredentials);
            document.getElementById('exportBlockchainBtn').addEventListener('click', exportBlockchainData);
            
            // Listen for new blockchain records
            window.addEventListener('blockchainUpdated', function(event) {
                loadBlockchainCredentials();
                updateBlockchainStats();
            });
            
            // Listen for achievement status updates
            window.addEventListener('achievementStatusUpdated', function(event) {
                console.log('Blockchain: Achievement status updated:', event.detail);
                if (event.detail.status === 'approved') {
                    // Reload blockchain credentials as new one might be added
                    setTimeout(() => {
                        loadBlockchainCredentials();
                        updateBlockchainStats();
                    }, 1000); // Small delay to ensure blockchain record is created
                }
            });
        }

        function loadBlockchainCredentials() {
            const blockchainRecords = window.studentCredoData.getBlockchainCredentials();
            const grid = document.getElementById('blockchainGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (blockchainRecords.length === 0) {
                emptyState.style.display = 'block';
                grid.style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            grid.style.display = 'grid';
            
            grid.innerHTML = blockchainRecords.map(record => `
                <div class="blockchain-credential-card" data-hash="${record.blockHash}">
                    <div class="credential-header">
                        <div class="blockchain-badge">
                            <i class="fas fa-cubes"></i>
                            <span>BLOCKCHAIN</span>
                        </div>
                        <div class="immutable-badge">
                            <i class="fas fa-lock"></i>
                            <span>IMMUTABLE</span>
                        </div>
                    </div>
                    
                    <div class="credential-content">
                        <div class="achievement-info">
                            <div class="achievement-category ${record.achievement.category}">
                                <i class="fas fa-${getCategoryIcon(record.achievement.category)}"></i>
                                <span>${formatCategory(record.achievement.category)}</span>
                            </div>
                            <h4>${record.achievement.title}</h4>
                            <p>${record.achievement.description || 'Verified achievement record'}</p>
                        </div>
                        
                        <div class="blockchain-metadata">
                            <div class="metadata-item">
                                <span class="label">Block Hash:</span>
                                <span class="value hash-value">${record.blockHash.substring(0, 16)}...</span>
                            </div>
                            <div class="metadata-item">
                                <span class="label">Timestamp:</span>
                                <span class="value">${formatBlockchainDate(record.timestamp)}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="label">Verified By:</span>
                                <span class="value">${record.verifiedBy || 'Admin'}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="label">Activity Points:</span>
                                <span class="value points">${getAchievementPoints(record.achievement)} AP</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credential-actions">
                        <button class="verify-btn" onclick="verifyCredential('${record.blockHash}')">
                            <i class="fas fa-search"></i>
                            Verify
                        </button>
                        <button class="share-btn" onclick="shareCredential('${record.blockHash}')">
                            <i class="fas fa-share"></i>
                            Share
                        </button>
                        <button class="details-btn" onclick="viewCredentialDetails('${record.blockHash}')">
                            <i class="fas fa-info-circle"></i>
                            Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateBlockchainStats() {
            const blockchainRecords = window.studentCredoData.getBlockchainCredentials();
            const currentCount = blockchainRecords.length;
            
            // Update all count displays
            document.getElementById('blockchainCount').textContent = currentCount;
            document.getElementById('verifiedCount').textContent = currentCount;
            document.getElementById('immutableCount').textContent = currentCount;
            document.getElementById('hashCount').textContent = currentCount;
            
            // Animate the main status count
            animateCounterTo('blockchainStatusCount', currentCount);
        }

        // Counter animation function
        function animateCounterTo(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const currentValue = parseInt(element.textContent) || 0;
            
            // If value is increasing, add a pulse animation
            if (targetValue > currentValue) {
                element.style.animation = 'pulse 0.6s ease-in-out';
                setTimeout(() => {
                    element.style.animation = '';
                }, 600);
            }
            
            const duration = 800; // 0.8 second animation
            const steps = 20;
            const increment = (targetValue - currentValue) / steps;
            let current = currentValue;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= targetValue) || (increment < 0 && current <= targetValue)) {
                    element.textContent = targetValue;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current);
                }
            }, duration / steps);
        }

        // Add CSS animation for pulse effect
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.2); color: #10b981; }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        function verifyCredential(blockHash) {
            const record = window.studentCredoData.getBlockchainCredentials().find(r => r.blockHash === blockHash);
            if (!record) return;
            
            const verificationDetails = document.getElementById('verificationDetails');
            verificationDetails.innerHTML = `
                <div class="verification-result success">
                    <div class="verification-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h4>Credential Verified Successfully</h4>
                    <p>This credential is authentic and stored on blockchain</p>
                </div>
                
                <div class="verification-data">
                    <h5>Credential Information</h5>
                    <div class="data-grid">
                        <div class="data-item">
                            <span class="label">Achievement:</span>
                            <span class="value">${record.achievement.title}</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Category:</span>
                            <span class="value">${formatCategory(record.achievement.category)}</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Block Hash:</span>
                            <span class="value hash-display">${record.blockHash}</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Timestamp:</span>
                            <span class="value">${new Date(record.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Verified By:</span>
                            <span class="value">${record.verifiedBy || 'System Admin'}</span>
                        </div>
                        <div class="data-item">
                            <span class="label">Activity Points:</span>
                            <span class="value">${getAchievementPoints(record.achievement)} AP</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('verificationModal').style.display = 'flex';
        }

        function verifyAllCredentials() {
            const blockchainRecords = window.studentCredoData.getBlockchainCredentials();
            
            if (blockchainRecords.length === 0) {
                showNotification('No blockchain credentials to verify', 'warning');
                return;
            }
            
            showNotification(`All ${blockchainRecords.length} credentials verified successfully!`, 'success');
        }

        function shareCredential(blockHash) {
            const record = window.studentCredoData.getBlockchainCredentials().find(r => r.blockHash === blockHash);
            if (!record) {
                showNotification('Credential not found!', 'error');
                return;
            }
            
            // Create comprehensive share data
            const shareData = {
                title: `Blockchain Credential: ${record.achievement.title}`,
                text: `Verified achievement: ${record.achievement.title}\nCategory: ${formatCategory(record.achievement.category)}\nVerified by: ${record.verifiedBy || 'System Admin'}\nActivity Points: ${getAchievementPoints(record.achievement)} AP\nBlock Hash: ${blockHash}\nTimestamp: ${formatBlockchainDate(record.timestamp)}`,
                url: window.location.href
            };
            
            // Try Web Share API first
            if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                navigator.share(shareData)
                    .then(() => showNotification('Credential shared successfully!', 'success'))
                    .catch((error) => {
                        console.log('Share failed:', error);
                        fallbackShare(shareData);
                    });
            } else {
                fallbackShare(shareData);
            }
        }
        
        function fallbackShare(shareData) {
            // Create a comprehensive text to copy
            const shareText = `ðŸ† ${shareData.title}

${shareData.text}

ðŸ”— View all credentials: ${shareData.url}

âœ… This credential is verified and stored on blockchain for authenticity.`;
            
            // Try clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareText)
                    .then(() => showNotification('Credential details copied to clipboard!', 'success'))
                    .catch(() => legacyShare(shareText));
            } else {
                legacyShare(shareText);
            }
        }
        
        function legacyShare(shareText) {
            // Legacy clipboard method
            const textArea = document.createElement('textarea');
            textArea.value = shareText;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('Credential details copied to clipboard!', 'success');
                } else {
                    showShareModal(shareText);
                }
            } catch (err) {
                showShareModal(shareText);
            }
            
            document.body.removeChild(textArea);
        }
        
        function showShareModal(shareText) {
            // Create a modal for manual copying
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; align-items: center;
                justify-content: center; z-index: 10001;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
                    <h3 style="margin: 0 0 20px 0; color: #1f2937;">
                        <i class="fas fa-share" style="margin-right: 10px; color: #3b82f6;"></i>
                        Share Credential
                    </h3>
                    <p style="margin: 0 0 15px 0; color: #6b7280;">Copy the text below to share this credential:</p>
                    <textarea readonly style="width: 100%; height: 200px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: monospace; font-size: 12px; resize: vertical;" onclick="this.select()">${shareText}</textarea>
                    <div style="margin-top: 20px; text-align: right;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            <i class="fas fa-times" style="margin-right: 5px;"></i>
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-select text
            const textarea = modal.querySelector('textarea');
            textarea.focus();
            textarea.select();
            
            showNotification('Select and copy the text above to share!', 'info');
        }

        function viewCredentialDetails(blockHash) {
            verifyCredential(blockHash);
        }

        function exportBlockchainData() {
            const blockchainRecords = window.studentCredoData.getBlockchainCredentials();
            
            if (blockchainRecords.length === 0) {
                showNotification('No blockchain data to export', 'warning');
                return;
            }
            
            const exportData = {
                student: window.studentCredoData.getUserProfile(),
                credentials: blockchainRecords,
                exportDate: new Date().toISOString(),
                totalRecords: blockchainRecords.length
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `blockchain-credentials-${Date.now()}.json`;
            link.click();
            
            showNotification('Blockchain data exported successfully!', 'success');
        }

        function closeVerificationModal() {
            document.getElementById('verificationModal').style.display = 'none';
        }

        // Utility functions
        function getCategoryIcon(category) {
            const icons = {
                'certificate': 'certificate',
                'competition-win': 'trophy',
                'internship': 'briefcase',
                'workshop': 'chalkboard-teacher',
                'freelancing': 'laptop-code'
            };
            return icons[category] || 'star';
        }

        function formatCategory(category) {
            const categories = {
                'certificate': 'Certificate',
                'competition-win': 'Competition Win',
                'internship': 'Internship',
                'workshop': 'Workshop',
                'freelancing': 'Freelancing'
            };
            return categories[category] || category;
        }

        function formatBlockchainDate(timestamp) {
            return new Date(timestamp).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getAchievementPoints(achievement) {
            const pointsMap = {
                'certificate': 5,
                'competition-win': 30,
                'internship': 30,
                'workshop': 5,
                'freelancing': 25
            };
            return pointsMap[achievement.category] || 5;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                color: white; padding: 16px 20px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 350px;
                font-size: 14px; font-weight: 500; transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
    </script>
</body>
</html>
